<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Realtime Pakan & Air</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f7fafc; color: #222; margin:0; padding:0; }
    .container { max-width: 500px; margin: 48px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 14px #0002; padding: 32px 24px; }
    h1 { text-align: center; margin-bottom: 32px; }
    .level-cards { display: flex; gap: 24px; flex-wrap: wrap; margin-bottom: 18px; }
    .level-card { flex: 1 1 0; min-width: 160px; background: linear-gradient(120deg,#f9fafb,#f1f5f9 85%); border-radius: 12px; box-shadow: 0 2px 8px #0001; padding: 18px 16px 14px 16px; }
    .level-header { font-weight:bold; font-size:1.08em; margin-bottom:10px; letter-spacing:0.2px; display:flex; align-items:center; gap:8px; }
    .level-bar-outer { background:#e5e7eb; border-radius:8px; height:22px; width:100%; margin-bottom:10px; overflow:hidden; }
    .level-bar-inner { height:100%; width:0%; border-radius:8px; transition:width 0.6s cubic-bezier(.4,2,.6,1); }
    .feed-card .level-bar-inner { background: linear-gradient(90deg,#fbbf24,#d97706); }
    .water-card .level-bar-inner { background: linear-gradient(90deg,#60a5fa,#2563eb); }
    .level-value { font-size:1.6em; font-weight:bold; text-align:right; display:flex; align-items:center; justify-content:flex-end; gap:10px; margin-top:2px; }
    .unit { font-size:0.85em; color:#6b7280; }
    .badge { border-radius:8px; padding:2px 11px; font-size:0.98em; font-weight:bold; margin-left:3px; min-width:54px; text-align:center; display:inline-block; }
    .badge-low { background:#f87171; color:#fff; }
    .badge-normal { background:#60a5fa; color:#fff; }
    .badge-full { background:#34d399; color:#fff; }
    @media (max-width:600px) { .container { padding: 16px 2vw; } .level-cards { flex-direction:column; gap:14px; } }
    .update-label { font-size:0.98em; color:#4a5568; margin-top:8px; display:block; text-align:right; }
    .error-msg { color:#e53e3e; font-size:0.98em; margin-top:8px; text-align:right; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Realtime Pakan & Air</h1>
    <div class="level-cards">
      <div class="level-card feed-card">
        <div class="level-header"><span class="material-icons" style="color:#d97706;">restaurant</span> Pakan</div>
        <div class="level-bar-outer"><div class="level-bar-inner" id="feed_level_bar"></div></div>
        <div class="level-value">
          <span id="feed_level_cm">-</span>
          <span class="unit">cm</span>
          <span id="feed_level_badge" class="badge"></span>
        </div>
      </div>
      <div class="level-card water-card">
        <div class="level-header"><span class="material-icons" style="color:#2563eb;">water_drop</span> Air</div>
        <div class="level-bar-outer"><div class="level-bar-inner" id="water_level_bar"></div></div>
        <div class="level-value">
          <span id="water_level_cm">-</span>
          <span class="unit">cm</span>
          <span id="water_level_badge" class="badge"></span>
        </div>
      </div>
    </div>
    <span id="last_update_label" class="update-label"></span>
    <div id="stock_error_msg" class="error-msg"></div>
  </div>
  <script>
    function safeGet(id) { return document.getElementById(id); }
    function setBadge(badge, val, max) {
      if (val === null) { badge.textContent = ''; badge.className = 'badge'; return; }
      let percent = Math.max(0, Math.min(100, (val/max)*100));
      if (percent < 30) { badge.textContent = 'LOW'; badge.className = 'badge badge-low'; }
      else if (percent > 80) { badge.textContent = 'FULL'; badge.className = 'badge badge-full'; }
      else { badge.textContent = 'NORMAL'; badge.className = 'badge badge-normal'; }
    }
    function updateStockUI(data) {
      const feedVal = (data.feed_level_cm !== undefined && data.feed_level_cm !== null && data.feed_level_cm !== '-') ? parseFloat(data.feed_level_cm) : null;
      const waterVal = (data.water_level_cm !== undefined && data.water_level_cm !== null && data.water_level_cm !== '-') ? parseFloat(data.water_level_cm) : null;
      const feedEl = safeGet('feed_level_cm');
      const waterEl = safeGet('water_level_cm');
      const feedBar = safeGet('feed_level_bar');
      const waterBar = safeGet('water_level_bar');
      const feedBadge = safeGet('feed_level_badge');
      const waterBadge = safeGet('water_level_badge');
      const errorMsg = safeGet('stock_error_msg');
      const lastUpdate = safeGet('last_update_label');
      if (feedEl) feedEl.textContent = (feedVal !== null ? feedVal : '-');
      if (waterEl) waterEl.textContent = (waterVal !== null ? waterVal : '-');
      if (feedBar) feedBar.style.width = (feedVal !== null) ? Math.max(0, Math.min(100, (feedVal/10)*100)) + '%' : '0%';
      if (waterBar) waterBar.style.width = (waterVal !== null) ? Math.max(0, Math.min(100, (waterVal/15)*100)) + '%' : '0%';
      setBadge(feedBadge, feedVal, 10);
      setBadge(waterBadge, waterVal, 15);
      if (feedVal !== null && waterVal !== null) {
        if (errorMsg) errorMsg.textContent = '';
      } else {
        if (errorMsg) errorMsg.textContent = 'Belum ada data pakan/air';
      }
      if (lastUpdate) lastUpdate.textContent = (data.last_update && data.last_update !== '-') ? `Update terakhir: ${data.last_update}` : '';
    }
    async function fetchCurrentStock() {
      try {
        const res = await fetch('https://pisces65.my.id/api/sensor/current_stock');
        const data = await res.json();
        updateStockUI(data);
      } catch (err) {
        updateStockUI({feaed_level_cm:null,water_level_cm:null,last_update:null});
        const errorMsg = safeGet('stock_error_msg');
        if (errorMsg) errorMsg.textContent = 'Gagal mengambil data pakan/air (backend tidak tersedia)';
        const lastUpdate = safeGet('last_update_label');
        if (lastUpdate) lastUpdate.textContent = '';
      }
    }
    window.addEventListener('DOMContentLoaded', function() {
      fetchCurrentStock();
      setInterval(fetchCurrentStock, 500);
    });
  </script>
</body>
</html>
